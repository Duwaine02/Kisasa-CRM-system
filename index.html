<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kisasa CRM – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --primary: #2563eb;
    --primary-light: #dbeafe;
    --sidebar-bg: #0b1f3b;
    --bg-main: #f1f5f9;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --success: #10b981;
    --danger: #ef4444;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
}

* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
body { background: var(--bg-main); display: flex; min-height: 100vh; color: var(--text-main); }

/* SIDEBAR */
.sidebar {
    width: 76px;
    background: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 0;
    position: fixed;
    height: 100vh;
    z-index: 1000;
}
.sidebar .logo {
    color: #60a5fa;
    font-weight: 800;
    font-size: 1.2rem;
    margin-bottom: 2.5rem;
}
.sidebar a {
    width: 46px;
    height: 46px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94a3b8;
    margin-bottom: 0.75rem;
    transition: all 0.3s;
    text-decoration: none;
}
.sidebar a:hover { background: rgba(255,255,255,0.08); color: white; }
.sidebar a.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

/* MAIN */
main { flex: 1; margin-left: 76px; padding: 2rem 2.5rem; }

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
.header h1 { font-size: 1.8rem; font-weight: 700; color: #0f172a; }
.user-info { display: flex; align-items: center; gap: 1rem; background: white; padding: 0.6rem 1.2rem; border-radius: 50px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary-light); color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; }
.logout { color: var(--text-muted); cursor: pointer; transition: 0.2s; }
.logout:hover { color: var(--danger); }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
.stat-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.stat-card p { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.6rem; text-transform: uppercase; }
.stat-card h2 { font-size: 2rem; font-weight: 800; margin: 0; }
.stat-card.revenue { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; }
.stat-card.revenue p { color: rgba(255,255,255,0.9); }

/* CHART */
.chart-container { background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 2.5rem; height: 320px; }

/* PIPELINE */
.pipeline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem; }
.column { background: white; border-radius: 16px; border: 1px solid var(--border); padding: 1.25rem; }
.column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--gray-200); }
.column-header h3 { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem; color: var(--text-main); }
.count-badge { background: var(--gray-100); color: var(--text-muted); font-size: 0.8rem; padding: 0.35rem 0.8rem; border-radius: 999px; font-weight: 600; }

.lead-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid var(--gray-200);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}
.lead-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-color: var(--primary);
}
.lead-card .drag-handle {
    color: var(--text-muted);
    font-size: 1.1rem;
    cursor: grab;
    padding-top: 0.25rem;
}
.lead-card .content {
    flex: 1;
}
.lead-card h4 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 0.35rem;
    color: var(--text-main);
}
.lead-card .price {
    color: var(--success);
    font-weight: 700;
    font-size: 1.15rem;
    margin-bottom: 0.9rem;
    display: block;
}

.lead-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid var(--gray-200);
}
.contact-icons {
    display: flex;
    gap: 1rem;
}
.contact-icons i {
    font-size: 1.1rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}
.contact-icons i:hover {
    color: var(--success);
    transform: scale(1.15);
}

.btn-options {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.1rem;
    cursor: pointer;
    padding: 0.4rem;
    border-radius: 50%;
    transition: all 0.2s;
}
.btn-options:hover {
    background: var(--gray-100);
    color: var(--primary);
}

.fab {
    position: fixed;
    bottom: 32px;
    right: 32px;
    width: 60px;
    height: 60px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1.6rem;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(37,99,235,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}
.fab:hover { transform: scale(1.1); background: #1d4ed8; }

.action-menu {
    position: absolute;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    width: 220px;
    z-index: 2000;
    padding: 0.5rem 0;
}
.action-menu button {
    width: 100%;
    padding: 0.7rem 1.2rem;
    text-align: left;
    background: none;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    transition: 0.2s;
}
.action-menu button:hover { background: var(--primary-light); color: var(--primary); }
.hidden { display: none !important; }

@media (max-width: 768px) {
    .pipeline-grid { grid-template-columns: 1fr; }
    main { padding: 1.5rem 1rem; }
    .fab { bottom: 20px; right: 20px; width: 56px; height: 56px; font-size: 1.4rem; }
    .lead-card { padding: 1rem; }
    .contact-icons { gap: 0.8rem; }
    .contact-icons i { font-size: 1rem; }
}
</style>
</head>
<body>

<aside class="sidebar">
    <div class="logo">Kisasa</div>
    <nav>
        <a href="index.html" class="active"><i class="fa-solid fa-gauge-high"></i></a>
        <a href="leads.html"><i class="fa-solid fa-user-plus"></i></a>
        <a href="clients.html"><i class="fa-solid fa-users"></i></a>
        <a href="quotes.html"><i class="fa-solid fa-file-invoice"></i></a>
        <a href="reports.html"><i class="fa-solid fa-chart-line"></i></a>
        <a href="settings.html"><i class="fa-solid fa-gear"></i></a>
    </nav>
</aside>

<main>
    <div class="header">
        <h1>Dashboard</h1>
        <div class="user-info">
            <div class="avatar" id="avatarLetter"></div>
            <span id="userFullName"></span>
            <i class="fa-solid fa-power-off logout" onclick="logout()"></i>
        </div>
    </div>

    <section class="stats-grid">
        <div class="stat-card"><p>New Leads</p><h2 id="newLeadsCount">0</h2></div>
        <div class="stat-card"><p>In Progress</p><h2 id="inProgressCount">0</h2></div>
        <div class="stat-card"><p>Converted</p><h2 id="convertedCount">0</h2></div>
        <div class="stat-card"><p>Win Rate</p><h2 id="winRate">0%</h2></div>
        <div class="stat-card revenue"><p>Total Revenue</p><h2 id="totalRevenue">R 0</h2></div>
    </section>

    <div class="chart-container">
        <canvas id="performanceChart"></canvas>
    </div>

    <section class="pipeline-grid">
        <div class="column">
            <div class="column-header">
                <h3><i class="fa-solid fa-note-sticky"></i> Drafts</h3>
                <span class="count-badge" id="draftCount">0</span>
            </div>
            <div id="draftsList"></div>
        </div>

        <div class="column">
            <div class="column-header">
                <h3><i class="fa-solid fa-list-check"></i> My Tasks</h3>
                <span class="count-badge" id="taskCount">0</span>
            </div>
            <div id="tasksList"></div>
        </div>

        <div class="column">
            <div class="column-header">
                <h3><i class="fa-solid fa-circle-check"></i> Completed</h3>
                <span class="count-badge" id="completeCount">0</span>
            </div>
            <div id="completedList"></div>
        </div>
    </section>
</main>

<button class="fab" onclick="openAddLead()"><i class="fa-solid fa-plus"></i></button>

<div id="actionMenu" class="action-menu hidden">
    <button onclick="sendQuote()"><i class="fa-solid fa-paper-plane"></i> Send Quote</button>
    <button onclick="moveLead('tasksList')"><i class="fa-solid fa-arrow-right"></i> Move to Tasks</button>
    <button onclick="moveLead('completedList')"><i class="fa-solid fa-check-double"></i> Mark Converted</button>
    <button style="color:var(--danger);" onclick="deleteLead()"><i class="fa-solid fa-trash"></i> Delete</button>
</div>

<script>
// ── User Info ──
const user = JSON.parse(localStorage.getItem("loggedInUser")) || {name:"Duwaine", surname:"Julies"};
document.getElementById("userFullName").textContent = user.name + " " + user.surname;
document.getElementById("avatarLetter").textContent = user.name.charAt(0);

function logout() {
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
}

function openAddLead() {
    window.location.href = "addNewlead.html";
}

// ── Leads Management ──
let leads = [];

try {
    leads = JSON.parse(localStorage.getItem("kisasa_leads") || "[]");
    if (!Array.isArray(leads)) leads = [];
} catch (e) {
    console.error("Invalid leads data in localStorage", e);
    leads = [];
}

function loadLeads() {
    const lists = {
        draftsList: document.getElementById("draftsList"),
        tasksList: document.getElementById("tasksList"),
        completedList: document.getElementById("completedList")
    };

    if (!lists.draftsList || !lists.tasksList || !lists.completedList) {
        console.warn("One or more list containers missing");
        return;
    }

    Object.values(lists).forEach(list => list.innerHTML = "");

    let newCount = 0, progressCount = 0, closedCount = 0, revenue = 0;

    leads.forEach(lead => {
        const card = document.createElement("div");
        card.className = "lead-card";
        card.id = lead.id || `lead-${Date.now()}`;
        card.innerHTML = `
            <div class="drag-handle"><i class="fa-solid fa-grip-lines"></i></div>
            <div class="content">
                <h4>${lead.firstName || ''} ${lead.lastName || ''}</h4>
                <span class="price">R ${(Number(lead.amount) || 0).toLocaleString()}</span>
                <div class="lead-footer">
                    <div class="contact-icons">
                        <i class="fa-solid fa-phone" title="Call" onclick="window.open('tel:${lead.phone || ''}')"></i>
                        <i class="fa-solid fa-envelope" title="Email" onclick="window.open('mailto:${lead.email || ''}')"></i>
                        <i class="fa-brands fa-whatsapp" title="WhatsApp" onclick="window.open('https://wa.me/${(lead.phone || '').replace('+','')}')"></i>
                    </div>
                    <button class="btn-options" title="Options" onclick="openMenu(event,this)"><i class="fa-solid fa-ellipsis-v"></i></button>
                </div>
            </div>
        `;

        if (lead.status === "draft") {
            lists.draftsList.appendChild(card);
            newCount++;
        } else if (lead.status === "in-progress") {
            lists.tasksList.appendChild(card);
            progressCount++;
        } else if (lead.status === "completed") {
            card.classList.add("completed");
            lists.completedList.appendChild(card);
            closedCount++;
            revenue += Number(lead.amount) || 0;
        }
    });

    document.getElementById("newLeadsCount").textContent = newCount + progressCount + closedCount;
    document.getElementById("inProgressCount").textContent = progressCount;
    document.getElementById("convertedCount").textContent = closedCount;
    document.getElementById("winRate").textContent = (newCount + progressCount > 0 ? Math.round((closedCount / (newCount + progressCount)) * 100) : 0) + "%";
    document.getElementById("totalRevenue").textContent = "R " + revenue.toLocaleString();

    document.getElementById("draftCount").textContent = newCount;
    document.getElementById("taskCount").textContent = progressCount;
    document.getElementById("completeCount").textContent = closedCount;
}

// ── Menu Positioning ──
let selectedLead = null;
const actionMenu = document.getElementById("actionMenu");

function openMenu(e, btn) {
    e.stopPropagation();
    selectedLead = btn.closest(".lead-card");

    const rect = selectedLead.getBoundingClientRect();
    let top = rect.bottom + window.scrollY + 8;
    let left = rect.right + window.scrollX - 220;

    // Flip if off-screen right
    if (left + 220 > window.innerWidth) left = rect.left + window.scrollX;

    // Flip above if bottom is off-screen
    if (top + 180 > window.innerHeight + window.scrollY) top = rect.top + window.scrollY - 180 - 8;

    actionMenu.style.top = top + "px";
    actionMenu.style.left = left + "px";
    actionMenu.classList.remove("hidden");
}

document.addEventListener("click", () => actionMenu.classList.add("hidden"));

function moveLead(targetId) {
    if (!selectedLead) return;
    const id = selectedLead.id;
    const lead = leads.find(l => l.id === id);
    if (lead) {
        lead.status = targetId === "completedList" ? "completed" : "in-progress";
        localStorage.setItem("kisasa_leads", JSON.stringify(leads));
    }
    document.getElementById(targetId).appendChild(selectedLead);
    loadLeads();
}

function deleteLead() {
    if (!selectedLead) return;
    const id = selectedLead.id;
    leads = leads.filter(l => l.id !== id);
    localStorage.setItem("kisasa_leads", JSON.stringify(leads));
    selectedLead.remove();
    loadLeads();
}

function sendQuote() {
    alert("Quote generation started...");
}

// ── Chart ──
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById('performanceChart');
  if (!canvas) {
    console.warn("Canvas #performanceChart not found");
    return;
  }

  const ctx = canvas.getContext('2d');
  const rootStyle = getComputedStyle(document.documentElement);
  const primaryColor = rootStyle.getPropertyValue('--primary').trim() || '#2563eb';
  const borderColor = rootStyle.getPropertyValue('--border').trim() || '#e2e8f0';

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
      datasets: [{
        label: 'Revenue',
        data: [12000, 19000, 15000, 22000, 28000, 34000],
        borderColor: primaryColor,
        backgroundColor: 'rgba(37,99,235,0.15)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#fff',
        pointBorderColor: primaryColor,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: borderColor } },
        x: { grid: { display: false } }
      }
    }
  });
});

// ── Initialize ──
loadLeads();
</script>
</body>
</html>