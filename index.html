<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kisasa CRM Dashboard</title> 

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="stylesheet.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #3b82f6;
      --sidebar-bg: #0f172a;
      --text-dark: #1e293b;
      --gray-200: #e5e7eb;
      --gray-100: #f3f4f6;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; color: var(--text-dark); min-height: 100vh; }

    .layout { display: flex; }

    .sidebar {
      width: 70px;
      background: var(--sidebar-bg);
      color: white;
      position: fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1.5rem;
      overflow-y: auto;
    }
    .sidebar h2 {
      color: white;
      font-size: 1.1rem;
      margin-bottom: 2rem;
      letter-spacing: 1px;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      margin-bottom: 1.25rem;
      font-size: 1.25rem;
      color: #cbd5e1;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .sidebar nav a:hover,
    .sidebar nav a.active {
      background: #1e293b;
      color: white;
    }

    .main.agent-ui {
      margin-left: 70px;
      flex: 1;
      padding: 1.5rem 2rem; /* Slightly reduced top/bottom padding */
      max-width: 1400px;
    }

    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem; /* Reduced */
      flex-wrap: wrap;
      gap: 1rem;
    }
    .agent-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filter-select {
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
    }
    .primary-btn {
      padding: 0.6rem 1.2rem;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      border-radius: 6px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
      font-size: 0.95rem;
      display: inline-block;
    }
    .primary-btn:hover {
      background: #2563eb;
    }
    .agent-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .agent-name {
      font-weight: 600;
      font-size: 14px;
    }

    .task-row {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: 10px;
      font-size: 14px;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .task-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .task-info .name {
      font-weight: 600;
    }
    .task-info .detail {
      font-size: 13px;
      color: #6b7280;
    }
    .task-info .amount {
      font-weight: 600;
      color: #1e40af;
    }

    .menu-btn {
      background: none;
      border: none;
      font-size: 16px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .menu-btn:hover {
      background: #e5e7eb;
      color: #1f2937;
    }

    .status {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      margin-left: 8px;
    }
    .hot  { background: #fee2e2; color: #991b1b; }
    .warm { background: #fef3c7; color: #92400e; }
    .cold { background: #e0f2fe; color: #0369a1; }
    .draft { background: #fde68a; color: #92400e; }
    .completed { background: #d1fae5; color: #065f46; }

    .dropdown {
      position: absolute;
      right: 10px;
      top: 40px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.1);
      display: none;
      z-index: 10;
      min-width: 160px;
    }
    .dropdown button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }
    .dropdown button:hover {
      background: #f3f4f6;
    }

    #tasks-container, #drafts-container, #completed-container {
      max-height: 420px; /* Slightly reduced to help fit more on screen */
      overflow-y: auto;
      padding: 8px;
    }

    /* Scrollbar styles unchanged */
    #tasks-container::-webkit-scrollbar,
    #drafts-container::-webkit-scrollbar,
    #completed-container::-webkit-scrollbar {
      width: 6px;
    }
    #tasks-container::-webkit-scrollbar-track,
    #drafts-container::-webkit-scrollbar-track,
    #completed-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    #tasks-container::-webkit-scrollbar-thumb,
    #drafts-container::-webkit-scrollbar-thumb,
    #completed-container::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 10px;
    }
    #tasks-container::-webkit-scrollbar-thumb:hover,
    #drafts-container::-webkit-scrollbar-thumb:hover,
    #completed-container::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    .stats.agent-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem; /* Reduced spacing */
    }
    .card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-width: 140px;
    }
    .card p {
      margin: 0;
      font-size: 0.9rem;
      color: #64748b;
    }
    .card h2 {
      margin: 0.25rem 0 0;
      font-size: 1.75rem;
    }

    .panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }
    .badge.count {
      background: #e5e7eb;
      color: #4b5563;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.25rem; /* Slightly reduced */
    }

    /* Performance Chart – made smaller to fit on screen */
    .performance-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.25rem;
      margin-bottom: 1.5rem; /* Reduced */
    }
    .performance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem; /* Reduced */
    }
    .performance-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .month-select {
      padding: 0.4rem 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 0.9rem;
    }
    .chart-container {
      position: relative;
      height: 180px; /* ← Made much smaller so everything fits */
    }
  </style>
</head>
<body>

<div class="layout">

  <aside class="sidebar">
    <h2>Kisasa</h2>
    <nav>
      <a href="/index.html" class="active" title="Dashboard"><i class="fas fa-tachometer-alt"></i></a>
      <a href="/leads.html" title="Leads"><i class="fas fa-user-plus"></i></a>
      <a href="/clients.html" title="Clients"><i class="fas fa-users"></i></a>
      <a href="/quotes.html" title="Quotes"><i class="fas fa-file-invoice-dollar"></i></a>
      <a href="/reports.html" title="Reports"><i class="fas fa-chart-line"></i></a>
      <a href="/settings.html" title="Settings"><i class="fas fa-cog"></i></a>
    </nav>
  </aside>

  <main class="main agent-ui">

    <header class="header agent-header">
      <h1>Agent Dashboard</h1>
      <div class="agent-actions">
        <a href="addNewlead.html" class="primary-btn">+ Add New Lead</a>

        <div class="agent-info">
          <span class="agent-name">Agent: Duwaine</span>
          <a href="login.html" class="menu-btn">Logout</a>
        </div>
      </div>
    </header>

    <!-- STATS -->
    <section class="stats agent-stats">
      <div class="card"><p>New</p><h2>3</h2></div>
      <div class="card"><p>Deals in progress</p><h2>2</h2></div>
      <div class="card"><p>Leads converted</p><h2>1</h2></div>
      <div class="card"><p>Win Rate</p><h2>33%</h2></div>
    </section>

    <!-- PERFORMANCE CHART – now compact -->
    <section class="performance-section">
      <div class="performance-header">
        <h3>Performance (Last 4 Weeks)</h3>
        <select class="month-select" id="monthSelect">
          <option value="jan">Jan 2026</option>
          <option value="feb" selected>Feb 2026</option>
          <option value="mar">Mar 2026</option>
          <option value="apr">Apr 2026</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
    </section>

    <!-- TASKS / DRAFTS / COMPLETED -->
    <section class="agent-grid">

      <div class="panel" id="tasks-panel">
        <div class="panel-header">
          <h3>My Tasks</h3>
          <span class="badge count" id="task-count">0</span>
        </div>
        <div id="tasks-container"></div>
      </div>

      <div class="panel" id="drafts-panel">
        <div class="panel-header">
          <h3>Drafts</h3>
          <span class="badge count" id="draft-count">0</span>
        </div>
        <div id="drafts-container"></div>
      </div>

      <div class="panel" id="completed-panel">
        <div class="panel-header">
          <h3>Completed</h3>
          <span class="badge count" id="completed-count">0</span>
        </div>
        <div id="completed-container"></div>
      </div>

    </section>

  </main>
</div>

<script>
// Prevent duplicates / race conditions
const recentlyMoved = new Set();

// Toggle dropdown
function toggleMenu(btn) {
  const menu = btn.nextElementSibling;
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

document.addEventListener("click", e => {
  if (!e.target.closest(".menu-btn")) {
    document.querySelectorAll(".dropdown").forEach(d => d.style.display = "none");
  }
});

// Send Quote
function sendQuote(btn) {
  const row = btn.closest(".task-row");
  if (!row) return;

  const name = row.dataset.name;
  const email = row.dataset.email;
  const phone = row.dataset.phone;
  const amount = row.dataset.amount;

  row.dataset.quoteInProgress = "true";

  window.open(
    `NewQuote.html?client=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&amount=${encodeURIComponent(amount)}`,
    '_blank'
  );

  const handler = function(event) {
    if (event.data.action === "quoteSent" && event.data.clientName === name) {
      if (recentlyMoved.has(name)) return;
      recentlyMoved.add(name);
      setTimeout(() => recentlyMoved.delete(name), 5000);

      moveTaskToDrafts(row);
      window.removeEventListener('message', handler);
    }
  };
  window.addEventListener('message', handler);
}

// Move to Drafts
function moveTaskToDrafts(row) {
  if (!row || row.dataset.moved) return;

  const name = row.dataset.name;

  if (recentlyMoved.has(name)) return;

  recentlyMoved.add(name);
  setTimeout(() => recentlyMoved.delete(name), 5000);

  row.dataset.moved = "true";

  let drafts = JSON.parse(localStorage.getItem('drafts')) || [];
  const alreadyExists = drafts.some(d => d.name === name);
  if (alreadyExists) {
    row.remove();
    updateCounts();
    return;
  }

  const email = row.dataset.email;
  const phone = row.dataset.phone;
  const amount = row.dataset.amount;

  row.remove();
  drafts.push({ name, email, phone, amount });
  localStorage.setItem('drafts', JSON.stringify(drafts));

  loadDrafts();
  updateCounts();
}

function moveToDraft(btn) {
  const row = btn.closest(".task-row");
  if (row.dataset.quoteInProgress === "true") {
    alert("Quote is being processed — please wait.");
    return;
  }
  moveTaskToDrafts(row);
}

function moveToCompleted(btn) {
  const row = btn.closest(".task-row");
  const name = row.dataset.name;
  const email = row.dataset.email;
  const phone = row.dataset.phone;
  const amount = row.dataset.amount;

  row.remove();
  let completed = JSON.parse(localStorage.getItem('completed')) || [];
  completed.push({ name, email, phone, amount });
  localStorage.setItem('completed', JSON.stringify(completed));
  loadCompleted();
  updateCounts();
}

function loadTasks() {
  const container = document.getElementById("tasks-container");
  container.innerHTML = '';

  const tasks = JSON.parse(localStorage.getItem('kisasa_leads') || '[]');

  tasks.forEach(task => {
    const randomAmount = Math.floor(Math.random() * (50000 - 1000 + 1)) + 1000;

    const row = document.createElement('div');
    row.className = 'task-row';
    row.dataset.name = `${task.firstName || ''} ${task.lastName || ''}`;
    row.dataset.email = task.email || '';
    row.dataset.phone = task.phone || '';
    row.dataset.amount = `R ${randomAmount.toLocaleString()}`;

    row.innerHTML = `
      <div class="task-info">
        <span class="name">${task.firstName || ''} ${task.lastName || ''}</span>
        <span class="detail">Email: ${task.email || '—'}</span>
        <span class="detail">Phone: ${task.phone || '—'}</span>
        <span class="amount">Amount: R ${randomAmount.toLocaleString()}</span>
      </div>
      <span class="status ${task.status || 'hot'}">${(task.status || 'HOT').toUpperCase()}</span>
      <button class="menu-btn" onclick="toggleMenu(this)">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <div class="dropdown">
        <button onclick="sendQuote(this)">Send Quote</button>
        <button onclick="moveToDraft(this)">Move to Draft</button>
        <button onclick="moveToCompleted(this)">Mark Completed</button>
      </div>
    `;
    container.appendChild(row);
  });

  updateCounts();
}

function loadDrafts() {
  const container = document.getElementById("drafts-container");
  container.innerHTML = '';
  const drafts = JSON.parse(localStorage.getItem('drafts')) || [];

  drafts.forEach(draft => {
    const row = document.createElement('div');
    row.className = 'task-row';
    row.dataset.name = draft.name;
    row.dataset.email = draft.email || '';
    row.dataset.phone = draft.phone || '';
    row.dataset.amount = draft.amount || '—';

    row.innerHTML = `
      <div class="task-info">
        <span class="name">${draft.name}</span>
        <span class="detail">Email: ${draft.email || '—'}</span>
        <span class="detail">Phone: ${draft.phone || '—'}</span>
        <span class="amount">${draft.amount || '—'}</span>
      </div>
      <span class="status draft">DRAFT</span>
      <button class="menu-btn" onclick="toggleMenu(this)">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <div class="dropdown">
        <button onclick="sendQuote(this)">Send Quote</button>
        <button onclick="moveToCompleted(this)">Move to Completed</button>
      </div>
    `;
    container.appendChild(row);
  });

  updateCounts();
}

function loadCompleted() {
  const container = document.getElementById("completed-container");
  container.innerHTML = '';
  const completed = JSON.parse(localStorage.getItem('completed')) || [];

  completed.forEach(item => {
    const row = document.createElement('div');
    row.className = 'task-row';
    row.innerHTML = `
      <div class="task-info">
        <span class="name">${item.name}</span>
        <span class="detail">Email: ${item.email || '—'}</span>
        <span class="detail">Phone: ${item.phone || '—'}</span>
        <span class="amount">${item.amount || '—'}</span>
      </div>
      <span class="status completed">COMPLETED</span>
    `;
    container.appendChild(row);
  });

  document.getElementById("completed-count").textContent = completed.length;
}

function updateCounts() {
  document.getElementById("task-count").textContent = document.querySelectorAll("#tasks-container .task-row").length;
  document.getElementById("draft-count").textContent = document.querySelectorAll("#drafts-container .task-row").length;
  document.getElementById("completed-count").textContent = document.querySelectorAll("#completed-container .task-row").length;
}

// Performance Chart Data (sample real data for months)
const monthlyData = {
  jan: {
    label: 'January 2026',
    weeklyConverted: [2, 4, 3, 5],
    weeklyDeals: [1, 2, 1, 3],
    totalConverted: 14,
    winRate: 35
  },
  feb: {
    label: 'February 2026',
    weeklyConverted: [3, 5, 6, 4],
    weeklyDeals: [2, 3, 4, 2],
    totalConverted: 18,
    winRate: 45
  },
  mar: {
    label: 'March 2026',
    weeklyConverted: [4, 3, 7, 5],
    weeklyDeals: [2, 2, 5, 3],
    totalConverted: 19,
    winRate: 48
  },
  apr: {
    label: 'April 2026',
    weeklyConverted: [5, 6, 4, 8],
    weeklyDeals: [3, 4, 2, 5],
    totalConverted: 23,
    winRate: 52
  }
};

// Initialize Chart
let performanceChart;
const ctx = document.getElementById('performanceChart').getContext('2d');

function createChart(month = 'feb') {
  const data = monthlyData[month];

  if (performanceChart) performanceChart.destroy();

  performanceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
      datasets: [
        {
          label: 'Leads Converted',
          data: data.weeklyConverted,
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 1
        },
        {
          label: 'Deals Closed',
          data: data.weeklyDeals,
          backgroundColor: 'rgba(16, 185, 129, 0.6)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count', font: { size: 12 } },
          ticks: { font: { size: 11 } }
        },
        x: {
          ticks: { font: { size: 11 } }
        }
      },
      plugins: {
        legend: { position: 'top', labels: { font: { size: 12 } } },
        title: {
          display: true,
          text: `${data.label} (Converted: ${data.totalConverted}, Win: ${data.winRate}%)`,
          font: { size: 14 }
        }
      }
    }
  });
}

// Update chart on month change
document.getElementById('monthSelect').addEventListener('change', function() {
  createChart(this.value);
});

window.addEventListener('message', function(event) {
  if (event.data.action === "quoteSent") {
    const rows = document.querySelectorAll("#tasks-container .task-row");
    for (let row of rows) {
      if (row.dataset.name === event.data.clientName) {
        moveTaskToDrafts(row);
        break;
      }
    }
  }
});

window.addEventListener('load', () => {
  loadTasks();
  loadDrafts();
  loadCompleted();
  createChart(); // Initial chart
});
</script>

</body>
</html>