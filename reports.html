<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - Kisasa CRM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <link href="https://cdn.webdatarocks.com/latest/webdatarocks.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.webdatarocks.com/latest/webdatarocks.toolbar.min.js"></script>
  <script src="https://cdn.webdatarocks.com/latest/webdatarocks.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --sidebar-bg: #0b1f3b;
      --bg-main: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body { background: var(--bg-main); display: flex; min-height: 100vh; color: var(--text-main); }

    .sidebar { width: 76px; background: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; position: fixed; height: 100vh; z-index: 1000; }
    .sidebar .logo { color: #60a5fa; font-weight: 800; font-size: 1.2rem; margin-bottom: 2.5rem; }
    .sidebar a { width: 46px; height: 46px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8; margin-bottom: 0.75rem; transition: all 0.3s; text-decoration: none; }
    .sidebar a:hover { background: rgba(255,255,255,0.08); color: white; }
    .sidebar a.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

    .main-wrapper { margin-left: 76px; flex: 1; padding: 2rem 2.5rem; max-width: 1400px; margin: 0 auto; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .top-bar h1 { font-size: 1.8rem; font-weight: 700; color: #0f172a; }
    .user-info { display: flex; align-items: center; gap: 1rem; background: white; padding: 0.6rem 1.2rem; border-radius: 50px; border: 1px solid var(--border); }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary-light); color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; }
    .logout { color: var(--text-muted); cursor: pointer; transition: 0.2s; }
    .logout:hover { color: var(--danger); }

    h2 { font-size: 1.4rem; font-weight: 700; margin: 2.5rem 0 1.25rem; color: #0f172a; }

    .pivot-container {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      overflow: hidden;
      height: 600px;
      margin-bottom: 2.5rem;
    }

    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      height: 400px;
    }

    @media (max-width: 1024px) {
      .main-wrapper { padding: 1.5rem 1.5rem; }
    }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">Kisasa</div>
  <nav>
    <a href="index.html" title="Dashboard"><i class="fa-solid fa-gauge-high"></i></a>
    <a href="leads.html" title="Leads"><i class="fa-solid fa-user-plus"></i></a>
    <a href="clients.html" title="Clients"><i class="fa-solid fa-users"></i></a>
    <a href="quotes.html" title="Quotes"><i class="fa-solid fa-file-invoice"></i></a>
    <a href="reports.html" class="active" title="Reports"><i class="fa-solid fa-chart-line"></i></a>
    <a href="settings.html" title="Settings"><i class="fa-solid fa-gear"></i></a>
  </nav>
</aside>

<div class="main-wrapper">
  <div class="top-bar">
    <h1>Reports & Analytics</h1>
    <div class="user-info">
      <div class="avatar" id="avatarLetter">D</div>
      <span id="userFullName"></span>
      <i class="fa-solid fa-power-off logout" onclick="logout()"></i>
    </div>
  </div>

  <h2>Interactive Report Builder</h2>
  <div id="pivot-container" class="pivot-container"></div>

  <h2>Visual Summary</h2>
  <div class="chart-container">
    <canvas id="dynamicChart"></canvas>
  </div>
</div>

<script>
// User info
const user = JSON.parse(localStorage.getItem("loggedInUser")) || {name:"Duwaine", surname:"Julies"};
document.getElementById("userFullName").textContent = user.name + " " + user.surname;
document.getElementById("avatarLetter").textContent = user.name.charAt(0);

function logout() {
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
}

// Sample data
const crmData = [
  { Month: "January", Agent: "Duwaine", LeadStatus: "Converted", DealAmount: 5000, Region: "Cape Town" },
  { Month: "January", Agent: "Duwaine", LeadStatus: "Hot", DealAmount: 0, Region: "Cape Town" },
  { Month: "January", Agent: "Sarah", LeadStatus: "Converted", DealAmount: 8000, Region: "Johannesburg" },
  { Month: "February", Agent: "Duwaine", LeadStatus: "Converted", DealAmount: 12000, Region: "Cape Town" },
  { Month: "February", Agent: "Duwaine", LeadStatus: "Warm", DealAmount: 0, Region: "Cape Town" },
  { Month: "February", Agent: "John", LeadStatus: "Converted", DealAmount: 6500, Region: "Durban" },
  { Month: "March", Agent: "Duwaine", LeadStatus: "Converted", DealAmount: 9000, Region: "Cape Town" },
  { Month: "March", Agent: "Sarah", LeadStatus: "Hot", DealAmount: 0, Region: "Johannesburg" },
  { Month: "April", Agent: "Duwaine", LeadStatus: "Converted", DealAmount: 15000, Region: "Cape Town" },
  { Month: "April", Agent: "John", LeadStatus: "Converted", DealAmount: 7000, Region: "Durban" },
];

// Pivot Table
let pivot = new WebDataRocks({
  container: "#pivot-container",
  toolbar: true,
  height: "100%",
  report: {
    dataSource: { data: crmData },
    slice: {
      rows: [{ uniqueName: "Month" }],
      columns: [{ uniqueName: "Measures" }],
      measures: [
        { uniqueName: "DealAmount", aggregation: "sum", caption: "Total Sales (R)" },
        { uniqueName: "Agent", aggregation: "count", caption: "Number of Deals" }
      ]
    }
  }
});

// Dynamic Chart
let dynamicChart = null;
const ctx = document.getElementById('dynamicChart').getContext('2d');

function createOrUpdateChart(data) {
  const labels = data.rows.map(row => row.join(" "));
  const values = data.data.map(cell => cell.v || 0);

  if (dynamicChart) {
    dynamicChart.data.labels = labels;
    dynamicChart.data.datasets[0].data = values;
    dynamicChart.update();
  } else {
    dynamicChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total Sales (R)',
          data: values,
          backgroundColor: '#2563eb',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#e5e7eb' } },
          x: { grid: { display: false } }
        }
      }
    });
  }
}

pivot.on("reportcomplete", function () {
  pivot.off("reportcomplete");
  pivot.getData(null, { callbackHandler: createOrUpdateChart });
});
</script>
</body>
</html>